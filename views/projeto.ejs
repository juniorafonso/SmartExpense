<h1 class="mb-4"><span class="fw-bold"><%= lang.project || 'Project' %>:</span> <%= projeto %></h1>

<style>
  table td, table th {
    border: 1px solid #dee2e6 !important;
  }
</style>

<div class="mb-3 text-start d-flex gap-2">
  <button class="btn btn-success" onclick="mostrarFormularioAdicionar()"><%= lang.add_expense || 'Add Expense' %></button>
  <a href="/projeto/<%= projeto %>/editar" class="btn btn-outline-primary"><%= lang.edit_project || 'Edit Project' %></a>
  <form action="/projetos/<%= projeto %>/delete" method="POST" onsubmit="return confirm('Are you sure you want to delete this project?')" style="display:inline;">
    <button type="submit" class="btn btn-outline-danger"><%= lang.delete || 'Delete' %></button>
  </form>
</div>

<h3><%= lang.expenses || 'Expenses' %>:</h3>
<table class="table">
  <thead>
    <tr>
      <th style="width: 40%;"><%= lang.name || 'Name' %></th>
      <th style="width: 10%;"><%= lang.date || 'Date' %></th>
      <th class="text-center" style="width: 10%;"><%= lang.type || 'Type' %></th>
      <th style="width: 10%;"><%= lang.iban || 'IBAN' %></th>
      <th style="width: 10%;" class="text-end"><%= lang.amount || 'Amount' %></th>
      <th class="text-center" style="width: 5%;"><%= lang.file || 'File' %></th>
      <th class="text-center" style="width: 5%;"><%= lang.actions || 'Actions' %></th>
      <th style="width: 10%;"><%= lang.observations || 'Observations' %></th>
    </tr>
  </thead>
  <tbody>
    <% let totalPaid = 0; let totalUnpaid = 0; let totalGeral = 0; %>
    <% despesas.forEach(despesa => { 
         const valor = parseFloat(despesa.valor) || 0;
         totalGeral += valor;
         if (despesa.status_pagamento === 'paid') totalPaid += valor;
         if (despesa.status_pagamento === 'unpaid') totalUnpaid += valor;
    %>
      <tr class="<%= despesa.status_pagamento === 'unpaid' ? 'table-danger' : 'table-success' %>">
        <td><%= despesa.nome %></td>
        <td><%= despesa.data %></td>
        <td class="text-center">
          <%= despesa.tipo === 'fixo' ? (lang.fixed || 'Fixed') : (lang.one_time || 'One-time') %>
        </td>
        <td><%= despesa.iban %></td>
        <td class="text-end"><%= Number(despesa.valor).toFixed(2) %></td>
        <td class="text-center">
          <% if (despesa.arquivo) { %>
            <a href="/uploads/<%= despesa.arquivo %>" target="_blank" class="text-decoration-none">ðŸ’¾</a>
          <% } else { %>
            ðŸš«
          <% } %>
        </td>
        <td class="text-center">
          <div class="dropdown">
            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
              <%= lang.actions || 'Actions' %>
            </button>
            <ul class="dropdown-menu">
              <li>
                <button type="button" class="dropdown-item" onclick="mostrarFormularioEditar(<%= despesa.id %>, '<%= despesa.nome %>', <%= despesa.valor %>, '<%= despesa.data %>', '<%= despesa.tipo %>', '<%= despesa.iban %>', '<%= despesa.observacoes %>', '<%= despesa.arquivo %>')">
                  <%= lang.edit || 'Edit' %>
                </button>
              </li>              
              <% if (despesa.status_pagamento === 'unpaid') { %>
                <li>
                  <form action="/projeto/<%= projeto %>/despesas/<%= despesa.id %>/pagar" method="POST" style="display:inline;">
                    <button type="submit" class="dropdown-item text-success">
                      <%= lang.mark_paid || 'Mark as paid' %>
                    </button>
                  </form>
                </li>
              <% } %>
              <li>
                <form action="/projeto/<%= projeto %>/despesas/<%= despesa.id %>/delete" method="POST" style="display:inline;">
                  <button type="submit" class="dropdown-item text-danger">
                    <%= lang.delete || 'Delete' %>
                  </button>
                </form>
              </li>
            </ul>
          </div>
        </td>
        <td><%= despesa.observacoes %></td>
      </tr>
    <% }); %>
    <tr class="bg-light fw-bold">
      <td colspan="4"></td>
      <td class="text-end"><%= totalPaid.toFixed(2) %></td>
      <td colspan="3"><%= lang.total_paid || 'Total Paid' %></td>
    </tr>
    <tr class="bg-light fw-bold">
      <td colspan="4"></td>
      <td class="text-end"><%= totalUnpaid.toFixed(2) %></td>
      <td colspan="3"><%= lang.total_unpaid || 'Total Unpaid' %></td>
    </tr>
    <tr class="bg-light fw-bold">
      <td colspan="4"></td>
      <td class="text-end"><%= totalGeral.toFixed(2) %></td>
      <td colspan="3"><%= lang.total_value || 'Total Value' %></td>
    </tr>
  </tbody>
</table>

<!-- Modal Adicionar -->
<div id="formAdicionarDespesa" class="position-fixed top-50 start-50 translate-middle bg-white border rounded shadow p-4" style="display: none; width: 40%; z-index: 1050;">
  <h5 class="mb-3"><%= lang.add_expense || 'Add Expense' %></h5>
  <form action="/projeto/<%= projeto %>/despesas" method="POST" enctype="multipart/form-data">
    <div class="mb-3">
      <label class="form-label"><%= lang.name || 'Name' %></label>
      <input type="text" class="form-control" name="nome" required>
    </div>
    <div class="mb-3">
      <label class="form-label"><%= lang.total_value || 'Amount' %></label>
      <input type="number" class="form-control" name="valor" required>
    </div>
    <div class="mb-3">
      <label class="form-label"><%= lang.date || 'Date' %></label>
      <input type="date" class="form-control" name="data" required>
    </div>
    <div class="mb-3">
      <label class="form-label"><%= lang.type || 'Type' %></label>
      <select class="form-select" name="tipo" required>
        <option value="fixo"><%= lang.fixed || 'Fixed' %></option>
        <option value="pontual"><%= lang.one_time || 'One-time' %></option>
      </select>
    </div>
    <div class="mb-3">
      <label class="form-label"><%= lang.file || 'File' %></label>
      <input type="file" class="form-control" name="arquivo">
    </div>
    <div class="mb-3">
      <label class="form-label">IBAN</label>
      <input type="text" class="form-control" name="iban">
    </div>
    <div class="mb-3">
      <label class="form-label"><%= lang.observations || 'Observations' %></label>
      <textarea class="form-control" name="observacoes"></textarea>
    </div>
    <div class="d-flex justify-content-between">
      <button type="submit" class="btn btn-primary"><%= lang.save || 'Save' %></button>
      <button type="button" class="btn btn-outline-secondary" onclick="fecharFormularios()"><%= lang.cancel || 'Cancel' %></button>
    </div>
  </form>
</div>

<!-- Modal Editar -->
<div id="formEditarDespesa" class="position-fixed top-50 start-50 translate-middle bg-white border rounded shadow p-4" style="display: none; width: 40%; z-index: 1050;">
  <h5 class="mb-3"><%= lang.edit || 'Edit' %> <%= lang.expense || 'Expense' %></h5>
  <form method="POST" enctype="multipart/form-data">
    <input type="hidden" name="id">
    <div class="mb-3">
      <label class="form-label"><%= lang.name || 'Name' %></label>
      <input type="text" class="form-control" name="nome" required>
    </div>
    <div class="mb-3">
      <label class="form-label"><%= lang.total_value || 'Amount' %></label>
      <input type="number" class="form-control" name="valor" required>
    </div>
    <div class="mb-3">
      <label class="form-label"><%= lang.date || 'Date' %></label>
      <input type="date" class="form-control" name="data" required>
    </div>
    <div class="mb-3">
      <label class="form-label"><%= lang.type || 'Type' %></label>
      <select class="form-select" name="tipo" required>
        <option value="fixo"><%= lang.fixed || 'Fixed' %></option>
        <option value="pontual"><%= lang.one_time || 'One-time' %></option>
      </select>
    </div>
    <div class="mb-3" id="arquivoAtualContainer" style="display: none;">
      <label class="form-label"><%= lang.current_file || 'Current file' %>:</label>
      <div class="d-flex justify-content-between align-items-center">
        <a id="arquivoAtualLink" href="#" target="_blank" class="text-decoration-none" id="nomeArquivoAtual"></a>
        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removerArquivoExistente()"><%= lang.remove || 'Remove' %></button>
      </div>
    </div>
    <div class="mb-3" id="campoNovoArquivo">
      <label class="form-label"><%= lang.file || 'File' %></label>
      <input type="file" class="form-control" name="arquivo">
    </div>
    <div class="mb-3">
      <label class="form-label">IBAN</label>
      <input type="text" class="form-control" name="iban">
    </div>
    <div class="mb-3">
      <label class="form-label"><%= lang.observations || 'Observations' %></label>
      <textarea class="form-control" name="observacoes"></textarea>
    </div>
    <div class="d-flex justify-content-between">
      <button type="submit" class="btn btn-primary"><%= lang.save || 'Save' %></button>
      <button type="button" class="btn btn-outline-secondary" onclick="fecharFormularios()"><%= lang.cancel || 'Cancel' %></button>
    </div>
  </form>
</div>

<script>
  function mostrarFormularioAdicionar() {
    const form = document.getElementById('formAdicionarDespesa');
    form.querySelector('form').reset();
    form.style.display = 'block';
  }

  function mostrarFormularioEditar(id, nome, valor, data, tipo, iban, observacoes, arquivo) {
    const form = document.getElementById('formEditarDespesa');
    const action = `/projeto/<%= projeto %>/despesa/${id}/editar`;
    form.querySelector('form').setAttribute('action', action);
    form.querySelector('input[name="id"]').value = id;
    form.querySelector('input[name="nome"]').value = nome;
    form.querySelector('input[name="valor"]').value = valor;
    form.querySelector('input[name="data"]').value = data;
    form.querySelector('select[name="tipo"]').value = tipo;
    form.querySelector('input[name="iban"]').value = iban;
    form.querySelector('textarea[name="observacoes"]').value = observacoes;

    if (arquivo) {
      document.getElementById('arquivoAtualContainer').style.display = 'block';
      document.getElementById('arquivoAtualLink').href = `/uploads/${arquivo}`;
      document.getElementById('arquivoAtualLink').textContent = arquivo;  // <-- Aqui
      document.getElementById('campoNovoArquivo').style.display = 'none';
    } else {
      document.getElementById('arquivoAtualContainer').style.display = 'none';
      document.getElementById('campoNovoArquivo').style.display = 'block';
    }

    form.style.display = 'block';
  }

  function removerArquivoExistente() {
    document.getElementById('arquivoAtualContainer').style.display = 'none';
    document.getElementById('campoNovoArquivo').style.display = 'block';
    const arquivoInput = document.querySelector('#formEditarDespesa input[name="arquivo"]');
    if (arquivoInput) arquivoInput.value = '';
  }

  function fecharFormularios() {
    document.getElementById('formAdicionarDespesa').style.display = 'none';
    document.getElementById('formEditarDespesa').style.display = 'none';
  }
</script>

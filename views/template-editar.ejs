<h1 class="mb-4">
  <span class="fw-bold"><%= lang.template || 'Template' %>:</span>
  <span id="template-nome-text"><%= template.nome %></span>
  <button class="btn btn-sm btn-link p-0 ms-2 text-decoration-none" data-bs-toggle="modal" data-bs-target="#editarNomeModal">‚úèÔ∏è</button>
</h1>

<!-- Modal editar nome do template -->
<div class="modal fade" id="editarNomeModal" tabindex="-1" aria-labelledby="editarNomeModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form action="/templates/<%= template.id %>/editar" method="POST">
        <div class="modal-header">
          <h5 class="modal-title"><%= lang.edit_template_name || 'Edit Template Name' %></h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <label class="form-label"><%= lang.template_name || 'Template Name' %></label>
          <input type="text" name="nome" class="form-control" value="<%= template.nome %>" required>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary"><%= lang.save || 'Save' %></button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><%= lang.cancel || 'Cancel' %></button>
        </div>
      </form>
    </div>
  </div>
</div>

<style>
  table td, table th {
    border: 1px solid #dee2e6 !important;
  }
</style>

<div class="mb-3 text-start d-flex gap-2">
  <button class="btn btn-success" onclick="mostrarFormularioAdicionar()"><%= lang.add_expense || 'Add Expense' %></button>
  <form action="/templates/<%= template.id %>/delete" method="POST" onsubmit="return confirm('Tem certeza?')" style="display:inline;">
    <button type="submit" class="btn btn-outline-danger"><%= lang.delete_template || 'Delete Template' %></button>
  </form>
</div>

<table class="table">
  <thead>
    <tr>
      <th style="width: 40%;"><%= lang.name || 'Name' %></th>
      <th style="width: 10%;"><%= lang.due || 'Due' %></th>
      <th class="text-center" style="width: 10%;"><%= lang.type || 'Type' %></th>
      <th style="width: 10%;">IBAN</th>
      <th class="text-end" style="width: 10%;"><%= lang.amount || 'Amount' %></th>
      <th class="text-center" style="width: 5%;"><%= lang.file || 'File' %></th>
      <th class="text-center" style="width: 5%;"><%= lang.actions || 'Actions' %></th>
      <th style="width: 10%;"><%= lang.observations || 'Observations' %></th>
    </tr>
  </thead>
  <tbody>
    <% let total = 0; %>
    <% despesas.forEach(d => {
         const valor = parseFloat(d.valor) || 0;
         total += valor;
    %>
      <tr>
        <td><%= d.nome %></td>
        <td><%= lang.every_day || 'Every' %> <%= d.dia_do_mes %></td>
        <td class="text-center">
          <%= d.tipo === 'fixo' ? (lang.fixed || 'Fixed') : (lang.one_time || 'One-time') %>
        </td>
        <td><%= d.iban %></td>
        <td class="text-end"><%= valor.toFixed(2) %></td>
        <td class="text-center">
          <% if (d.arquivo) { %>
            <a class="text-decoration-none" href="/uploads/<%= d.arquivo %>" target="_blank">üíæ</a>
          <% } else { %>
            üö´
          <% } %>
        </td>
        <td class="text-center">
          <div class="dropdown">
            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
              <%= lang.actions || 'Actions' %>
            </button>
            <ul class="dropdown-menu">
              <li>
                <button
                  type="button"
                  class="dropdown-item"
                  onclick="preencherModal(this)"
                  data-id="<%= d.id %>"
                  data-nome="<%= d.nome %>"
                  data-valor="<%= d.valor %>"
                  data-dia="<%= d.dia_do_mes %>"
                  data-tipo="<%= d.tipo %>"
                  data-iban="<%= d.iban %>"
                  data-observacoes="<%= d.observacoes %>"
                  data-arquivo="<%= d.arquivo %>"
                ><%= lang.edit || 'Edit' %></button>
              </li>
              <li>
                <form action="/templates/<%= template.id %>/despesas/<%= d.id %>/delete" method="POST" class="d-inline">
                  <button type="submit" class="dropdown-item text-danger"><%= lang.delete || 'Delete' %></button>
                </form>
              </li>
            </ul>
          </div>
        </td>
        <td><%= d.observacoes %></td>
      </tr>
    <% }); %>
    <tr class="bg-light fw-bold">
      <td colspan="4"></td>
      <td class="text-end"><%= total.toFixed(2) %></td>
      <td colspan="3" class="text-start"><%= lang.total_value || 'Total Value' %></td>
    </tr>
  </tbody>
</table>

<!-- Modal de Adicionar Despesa -->
<div id="formAdicionarDespesa" class="position-fixed top-50 start-50 translate-middle bg-white border rounded shadow p-4" style="display:none; width: 40%; z-index: 1050;">
  <h5 class="mb-3"><%= lang.add_expense || 'Add Expense' %></h5>
  <form action="/templates/<%= template.id %>/despesas" method="POST" enctype="multipart/form-data">
    <div class="mb-3">
      <label class="form-label"><%= lang.name || 'Name' %></label>
      <input type="text" class="form-control" name="nome" required>
    </div>
    <div class="mb-3">
      <label class="form-label"><%= lang.amount || 'Amount' %></label>
      <input type="number" class="form-control" name="valor" required>
    </div>
    <div class="mb-3">
      <label class="form-label"><%= lang.day_of_month || 'Day of month' %></label>
      <select name="dia_do_mes" class="form-select" required>
        <% for (let i = 1; i <= 31; i++) { %>
          <option value="<%= i %>"><%= i %></option>
        <% } %>
      </select>
    </div>
    <div class="mb-3">
      <label class="form-label"><%= lang.type || 'Type' %></label>
      <select class="form-select" name="tipo" required>
        <option value="fixo"><%= lang.fixed || 'Fixed' %></option>
        <option value="pontual"><%= lang.one_time || 'One-time' %></option>
      </select>
    </div>
    <div class="mb-3">
      <label class="form-label">IBAN</label>
      <input type="text" class="form-control" name="iban">
    </div>
    <div class="mb-3">
      <label class="form-label"><%= lang.observations || 'Observations' %></label>
      <textarea class="form-control" name="observacoes"></textarea>
    </div>
    <div class="mb-3">
      <label class="form-label"><%= lang.file || 'File' %></label>
      <input type="file" class="form-control" name="arquivo">
    </div>
    <div class="d-flex justify-content-between">
      <button type="submit" class="btn btn-primary"><%= lang.save || 'Save' %></button>
      <button type="button" class="btn btn-outline-secondary" onclick="fecharFormulario()"><%= lang.cancel || 'Cancel' %></button>
    </div>
  </form>
</div>

<!-- Modal de Editar Despesa -->
<div id="formEditarDespesa" class="position-fixed top-50 start-50 translate-middle bg-white border rounded shadow p-4" style="display:none; width: 40%; z-index: 1050;">
  <h5 class="mb-3"><%= lang.edit || 'Edit' %> <%= lang.expense || 'Expense' %></h5>
  <form method="POST" enctype="multipart/form-data">
    <input type="hidden" name="id">
    <div class="mb-3">
      <label class="form-label"><%= lang.name || 'Name' %></label>
      <input type="text" class="form-control" name="nome" required>
    </div>
    <div class="mb-3">
      <label class="form-label"><%= lang.amount || 'Amount' %></label>
      <input type="number" class="form-control" name="valor" required>
    </div>
    <div class="mb-3">
      <label class="form-label"><%= lang.day_of_month || 'Day of month' %></label>
      <select name="dia_do_mes" class="form-select" required>
        <% for (let i = 1; i <= 31; i++) { %>
          <option value="<%= i %>"><%= i %></option>
        <% } %>
      </select>
    </div>
    <div class="mb-3">
      <label class="form-label"><%= lang.type || 'Type' %></label>
      <select class="form-select" name="tipo" required>
        <option value="fixo"><%= lang.fixed || 'Fixed' %></option>
        <option value="pontual"><%= lang.one_time || 'One-time' %></option>
      </select>
    </div>
    <div class="mb-3" id="arquivoAtualContainer" style="display: none;">
      <label class="form-label"><%= lang.current_file || 'Current file' %>:</label>
      <div class="d-flex justify-content-between align-items-center">
        <a id="arquivoAtualLink" href="#" target="_blank" class="text-decoration-none"></a>
        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removerArquivoExistente()"><%= lang.remove || 'Remove' %></button>
      </div>
    </div>
    <div class="mb-3" id="campoNovoArquivo">
      <label class="form-label"><%= lang.file || 'File' %></label>
      <input type="file" class="form-control" name="arquivo">
    </div>
    <div class="mb-3">
      <label class="form-label">IBAN</label>
      <input type="text" class="form-control" name="iban">
    </div>
    <div class="mb-3">
      <label class="form-label"><%= lang.observations || 'Observations' %></label>
      <textarea class="form-control" name="observacoes"></textarea>
    </div>
    <div class="d-flex justify-content-between">
      <button type="submit" class="btn btn-primary"><%= lang.save || 'Save' %></button>
      <button type="button" class="btn btn-outline-secondary" onclick="fecharFormulario()"><%= lang.cancel || 'Cancel' %></button>
    </div>
  </form>
</div>

<script>
  function mostrarFormularioAdicionar() {
    document.getElementById('formAdicionarDespesa').style.display = 'block';
  }

  function preencherModal(botao) {
    const form = document.getElementById('formEditarDespesa');
    form.querySelector('form').reset();

    form.querySelector('form').setAttribute('action', `/templates/<%= template.id %>/despesa/${botao.dataset.id}/editar`);
    form.querySelector('input[name="id"]').value = botao.dataset.id;
    form.querySelector('input[name="nome"]').value = botao.dataset.nome;
    form.querySelector('input[name="valor"]').value = botao.dataset.valor;
    form.querySelector('select[name="dia_do_mes"]').value = botao.dataset.dia;
    form.querySelector('select[name="tipo"]').value = botao.dataset.tipo;
    form.querySelector('input[name="iban"]').value = botao.dataset.iban;
    form.querySelector('textarea[name="observacoes"]').value = botao.dataset.observacoes;

    if (botao.dataset.arquivo) {
      document.getElementById('arquivoAtualContainer').style.display = 'block';
      document.getElementById('arquivoAtualLink').href = `/uploads/${botao.dataset.arquivo}`;
      document.getElementById('arquivoAtualLink').textContent = botao.dataset.arquivo;
      document.getElementById('campoNovoArquivo').style.display = 'none';
    } else {
      document.getElementById('arquivoAtualContainer').style.display = 'none';
      document.getElementById('campoNovoArquivo').style.display = 'block';
    }

    form.style.display = 'block';
  }

  function removerArquivoExistente() {
    document.getElementById('arquivoAtualContainer').style.display = 'none';
    document.getElementById('campoNovoArquivo').style.display = 'block';
    document.querySelector('#formEditarDespesa input[name="arquivo"]').value = '';
  }

  function fecharFormulario() {
    document.getElementById('formAdicionarDespesa').style.display = 'none';
    document.getElementById('formEditarDespesa').style.display = 'none';
  }
</script>
